import B from"./FetcherLayout.b4b9b0e2.js";import{N as R}from"./NavPageLink.4d27d314.js";import{d as C,f,a as j}from"./fetch.01f53e84.js";import"./moment.9709ab41.js";import{E as G}from"./echo.4216f5db.js";import{u as T,r as E,m as U,e as M,T as H}from"./Tooltip.584175fd.js";import{o as r,d as o,e,t as n,j as c,k as Q,O as Y,P as L,f as Z,M as A,p as O,m as q,r as _,a as p,w as u,Q as S,F as P,l as J,c as $,b as y,n as K,h as X}from"./app.6256a668.js";import{_ as z}from"./Layout.7e513d1b.js";import{E as x}from"./EmailStatus.293a952a.js";var tt={data:()=>({data:{},states:{},previousState:null,state:null}),methods:{send(t,i){this.data=i||{};var s=this.states[this.state][t]||this.states[this.state]["*"];s&&(this.previousState=this.state,this.state=s,(this["state"+this.state[0].toUpperCase()+this.state.slice(1)]||function(){})())}}};const et={mixins:[tt],inheritAttrs:!1,props:{modelValue:{type:String,required:!0},submit:{type:Function,required:!0},validation:{type:Object,default:null},disabled:{type:Boolean,default:!1}},setup:()=>({v$:T()}),validations(){if(this.$el)return{newValue:this.validation||{}}},data(){return{states:Object.freeze({view:{edit:"editing"},editing:{validate:"editingValidating",cancel:"view",blur:"editingBlur"},editingBlur:{same:"view",different:"editingValidating"},editingValid:{validate:"editingValidating",submit:"viewUpdating",cancel:"view",blur:"editingBlur"},editingInvalid:{validate:"editingValidating",cancel:"view"},editingValidating:{valid:"editingValid",invalid:"editingInvalid"},viewUpdating:{success:"viewUpdated",error:"viewError"},viewUpdated:{edit:"editing",timer:"view"},viewError:{edit:"editing",resend:"viewUpdating"}}),state:"view",newValue:this.modelValue}},computed:{isSame(){return this.newValue===this.modelValue},view(){return this.state.startsWith("view")},updating(){return this.state==="viewUpdating"}},methods:{onBlur(){this.v$.$touch(),this.send("blur")},onCancel(){this.v$.$reset(),this.send("cancel")},onInput(){this.v$.$error&&this.v$.$touch(),this.send("validate")},onSubmit(){this.v$.$touch(),this.send("submit")},onResend(){this.send("resend")},stateView(){this.newValue=this.modelValue},stateEditing(){this.$nextTick(()=>this.$refs.input.focus())},stateEditingBlur(){this.isSame?this.send("same"):this.send("different")},stateEditingValidating(){this.v$.$invalid||this.$el.querySelectorAll("input:invalid").length>0?this.send("invalid"):this.send("valid")},stateViewUpdating(){this.submit(this.newValue).then(()=>{this.send("success")}).catch(t=>{this.send("error",{message:t})})},stateViewUpdated(){setTimeout(()=>{this.send("timer")},5e3)}}},b=t=>(O("data-v-4813bc65"),t=t(),q(),t),it=["disabled"],at=["data-state","data-previous-state"],st={role:"alert",style:{display:"none"}},nt={key:0,class:"input-group-prepend"},rt=b(()=>e("i",{class:"input-group-text fas fa-spinner fa-spin"},null,-1)),ot=[rt],dt={key:1,class:"input-group-prepend"},lt=b(()=>e("i",{class:"input-group-text fas fa-check"},null,-1)),ut=[lt],ct={key:2,class:"input-group-prepend"},ht=["title"],pt=["disabled","aria-invalid","title"],mt={class:"input-group-append"},gt=["disabled"],_t=b(()=>e("i",{class:"fas fa-sync"},null,-1)),ft=[_t],bt=["disabled"],vt=b(()=>e("i",{class:"fas fa-edit"},null,-1)),wt=[vt],yt=["disabled"],$t=b(()=>e("i",{class:"fas fa-check-circle"},null,-1)),zt=[$t],kt=b(()=>e("i",{class:"fas fa-times-circle"},null,-1)),Vt=[kt];function St(t,i,s,V,h,a){return r(),o("form",{method:"post",autocomplete:"off",onSubmit:i[6]||(i[6]=A((...d)=>a.onSubmit&&a.onSubmit(...d),["prevent"]))},[e("fieldset",{disabled:a.updating||s.disabled},[e("div",{class:"input-group","data-state":h.state,"data-previous-state":t.previousState},[e("h2",st,n(t.data.message),1),a.updating?(r(),o("div",nt,ot)):c("",!0),h.state==="viewUpdated"?(r(),o("div",dt,ut)):c("",!0),h.state==="viewError"?(r(),o("div",ct,[e("i",{class:"input-group-text fas fa-exclamation-circle",title:t.data.message},null,8,ht)])):c("",!0),Q(e("input",L({ref:"input","onUpdate:modelValue":i[0]||(i[0]=d=>h.newValue=d),name:"input"},t.$attrs,{class:{"form-control":!0,"is-invalid":t.v$.$error},disabled:a.view,"aria-invalid":t.v$.$error,title:t.data.message,onInput:i[1]||(i[1]=(...d)=>a.onInput&&a.onInput(...d))}),null,16,pt),[[Y,h.newValue]]),Z(t.$slots,"errors",{},void 0,!0),e("div",mt,[h.state==="viewError"?(r(),o("button",{key:0,type:"button",class:"btn btn-outline-primary",disabled:s.disabled,onClick:i[2]||(i[2]=(...d)=>a.onResend&&a.onResend(...d))},ft,8,gt)):c("",!0),h.state.startsWith("view")?(r(),o("button",{key:1,type:"button",class:"btn btn-outline-primary",disabled:s.disabled,onClick:i[3]||(i[3]=d=>t.send("edit"))},wt,8,bt)):c("",!0),h.state.startsWith("edit")?(r(),o("button",{key:2,type:"button",class:"btn btn-outline-success",disabled:a.isSame||!h.state.endsWith("Valid")||s.disabled,onClick:i[4]||(i[4]=(...d)=>a.onSubmit&&a.onSubmit(...d))},zt,8,yt)):c("",!0),h.state.startsWith("edit")?(r(),o("button",{key:3,type:"button",class:"btn btn-outline-danger",onClick:i[5]||(i[5]=(...d)=>a.onCancel&&a.onCancel(...d))},Vt)):c("",!0)])],8,at)],8,it)],32)}var jt=z(et,[["render",St],["__scopeId","data-v-4813bc65"]]);const Et={components:{InputEdit:jt,EmailStatus:x},setup:()=>({v$:T()}),validations:()=>({name:{required:E,maxLength:U(55),unique(t){return t===""?!0:Object.values(this.participants).filter(i=>i.name===t).length===1}},email:{required:E,maxLength:U(320),format:M}}),props:{name:{type:String,required:!0},email:{type:String,required:!0},target:{type:String},mail:{type:Object,required:!0},participants:{type:Object,required:!0},finished:{type:Boolean,required:!0},canWithdraw:{type:Boolean,required:!0},updateEmail:{type:Function,required:!0},updateName:{type:Function,required:!0}}},Ut={key:0,class:"invalid-tooltip"},Pt={key:1,class:"invalid-tooltip"},Ct={key:0,class:"invalid-tooltip"},Tt={key:1,class:"invalid-tooltip"},Lt={key:0},Ot={key:1},qt=e("i",{class:"fas fa-minus"},null,-1);function It(t,i,s,V,h,a){const d=_("InputEdit"),m=_("EmailStatus");return r(),o("tr",null,[e("td",null,[p(d,{modelValue:s.name,validation:t.v$.name,submit:s.updateName,disabled:s.finished},{errors:u(()=>[t.v$.name.required?t.v$.name.unique?c("",!0):(r(),o("div",Pt,n(t.$t("validation.custom.randomform.participant.name.distinct")),1)):(r(),o("div",Ut,n(t.$t("validation.custom.randomform.participant.name.required")),1))]),_:1},8,["modelValue","validation","submit","disabled"])]),e("td",null,[p(d,{modelValue:s.email,validation:t.v$.email,submit:s.updateEmail,disabled:s.finished},{errors:u(()=>[t.v$.email.required?t.v$.email.format?c("",!0):(r(),o("div",Tt,n(t.$t("validation.custom.organizer.email.format")),1)):(r(),o("div",Ct,n(t.$t("validation.custom.organizer.email.required")),1))]),_:1},8,["modelValue","validation","submit","disabled"])]),s.finished?(r(),o("td",Lt,n(s.target),1)):c("",!0),e("td",null,[p(m,{delivery_status:s.mail.delivery_status,last_update:s.mail.updated_at,disabled:s.finished,onRedo:i[0]||(i[0]=l=>t.$emit("resend"))},null,8,["delivery_status","last_update","disabled"])]),s.canWithdraw?(r(),o("td",Ot,[e("button",{type:"button",class:"btn btn-outline-danger participant-remove",onClick:i[1]||(i[1]=l=>t.confirmWithdrawal(t.k))},[qt,e("span",null,n(t.$t("organizer.withdraw.button")),1)])])):c("",!0)])}var Nt=z(Et,[["render",It]]),Dt="/build/assets/srikanta-h-u-TrGVhbsUf40-unsplash.be9b6bde.avif",Ft="/build/assets/srikanta-h-u-TrGVhbsUf40-unsplash.4471f4b6.webp",I="/build/assets/srikanta-h-u-TrGVhbsUf40-unsplash.6816af8d.jpg",Wt="/build/assets/lynda-hinton-QyDLHeUerd4-unsplash.9b9c28b0.avif",Bt="/build/assets/lynda-hinton-QyDLHeUerd4-unsplash.4ee30b51.webp",N="/build/assets/lynda-hinton-QyDLHeUerd4-unsplash.5f3e2c02.jpg",D="/build/assets/rune-haugseng-UCzjZPCGV1Y-unsplash.3341c429.avif",F="/build/assets/rune-haugseng-UCzjZPCGV1Y-unsplash.135a646a.webp",k="/build/assets/rune-haugseng-UCzjZPCGV1Y-unsplash.fec52c3e.jpg",Rt="/build/assets/mike-arney-9r-_2gzP37k-unsplash.080a6716.avif",Gt="/build/assets/mike-arney-9r-_2gzP37k-unsplash.eca00fd8.webp",W="/build/assets/mike-arney-9r-_2gzP37k-unsplash.6dd52eac.jpg";const Mt={components:{Tooltip:H,ParticipantRow:Nt},props:{participants:{type:Object,required:!0},draw:{type:Object,required:!0},routes:{type:Object,required:!0}},computed:{canWithdraw(){return Object.keys(this.participants).length>3},checkUpdates(){return!!Object.values(this.participants).find(t=>t.mail.delivery_status!=="error")},finished(){return!!this.draw.finished_at},endDateLong(){return new Date(this.draw.finished_at).toLocaleString("fr-FR",{day:"numeric",month:"long",year:"numeric"})},deletionDateLong(){return new Date(this.draw.deletes_at).toLocaleString("fr-FR",{day:"numeric",month:"long",year:"numeric"})}},created(){G.channel("draw."+this.draw.hash).listen(".mail.update",t=>{var i=Object.keys(this.participants).find(s=>this.participants[s].mail.id===t.id);i&&(this.participants[i].mail.delivery_status=t.delivery_status,this.participants[i].mail.updated_at=t.updated_at)}),window.localStorage.setItem("secretsanta",JSON.stringify(C(JSON.parse(window.localStorage.getItem("secretsanta"))||{},{[this.draw.hash]:{title:this.draw.mail_title,creation:this.draw.created_at,deletion:this.draw.deletes_at,organizerName:this.draw.organizer_name,links:{org:{link:window.location.href}}}})))},methods:{confirmPurge(){let t={okText:this.$t("organizer.purge.confirm.ok"),cancelText:this.$t("organizer.purge.confirm.cancel"),verification:this.$t("organizer.purge.confirm.value"),verificationHelp:this.$t("organizer.purge.confirm.help"),type:"hard",customClass:"purge"},i={title:this.$t("organizer.purge.confirm.title",{deletion:this.deletionDateLong}),body:""};this.draw.next_solvable&&!this.finished?i.body=this.$t("organizer.purge.confirm.body_final"):this.finished?i.body=this.$t("organizer.purge.confirm.body_finished"):i.body=this.$t("organizer.purge.confirm.body_nofinal"),this.$dialog.confirm(i,t).then(this.purge)},purge(){return f(this.routes.deleteUrl,"DELETE").then(t=>{this.$dialog.alert(t.message).then(()=>window.location.pathname="/")})},resendTarget(t){return this.participants[t].mail.delivery_status="created",this.participants[t].mail.updated_at=new Date().getTime(),f(this.participants[t].resendTargetUrl)},updateEmail(t,i){return this.participants[t].email=i,this.participants[t].mail.delivery_status="created",this.participants[t].mail.updated_at=new Date().getTime(),f(this.participants[t].changeEmailUrl,"POST",{email:i}).catch(s=>Promise.reject(s.errors.email[0]))},updateName(t,i){return this.participants[t].name=i,f(this.participants[t].changeNameUrl,"POST",{name:i}).catch(s=>Promise.reject(s.errors.name[0]))},confirmWithdrawal(t){let i={okText:this.$t("organizer.withdraw.confirm.ok"),cancelText:this.$t("organizer.withdraw.confirm.cancel"),verification:this.$t("organizer.withdraw.confirm.value"),verificationHelp:this.$t("organizer.withdraw.confirm.help"),type:"hard",customClass:"withdraw"};this.$dialog.confirm({title:this.$t("organizer.withdraw.confirm.title",{deletion:this.deletionDateLong}),body:this.$t("organizer.withdraw.confirm.body",{name:this.participants[t].name})},i).then(()=>this.withdraw(t))},withdraw(t){return f(this.participants[t].withdrawalUrl).then(i=>{this.$delete(this.participants,t),this.$dialog.alert(i.message)})},download(){f(this.routes.csvInitUrl,"GET","",{responseType:"blob"}).then(t=>{j(t,"secretsanta_"+this.draw.hash+"_init.csv","text/csv")})},downloadPlus(){f(this.routes.csvFinalUrl,"GET","",{responseType:"blob"}).then(t=>{j(t,"secretsanta_"+this.draw.hash+"_full.csv","text/csv")})}}},g=t=>(O("data-v-7119bea2"),t=t(),q(),t),Ht=Dt,Qt=Ft,Yt=I,Zt=Wt,At=Bt,Jt=N,Kt=D,Xt=F,xt=k,te=Rt,ee=Gt,ie=W,ae=D,se=F,ne=k,re={key:0,class:"alert alert-warning",role:"alert"},oe={class:"table table-hover"},de={class:"table-active"},le={key:0,style:{width:"25%"},scope:"col"},ue={key:1,style:{width:"3%"},scope:"col"},ce=g(()=>e("picture",null,[e("source",{srcset:Ht,type:"image/avif"}),e("source",{srcset:Qt,type:"image/webp"}),e("source",{srcset:Yt,type:"image/jpg"}),e("img",{class:"media-object",src:I})],-1)),he={class:"text-content"},pe=g(()=>e("i",{class:"fas fa-calendar-check"},null,-1)),me=g(()=>e("picture",null,[e("source",{srcset:Zt,type:"image/avif"}),e("source",{srcset:At,type:"image/webp"}),e("source",{srcset:Jt,type:"image/jpg"}),e("img",{class:"media-object",src:N})],-1)),ge={class:"text-content"},_e=g(()=>e("i",{class:"fas fa-trash"},null,-1)),fe=g(()=>e("picture",null,[e("source",{srcset:Kt,type:"image/avif"}),e("source",{srcset:Xt,type:"image/webp"}),e("source",{srcset:xt,type:"image/jpg"}),e("img",{class:"media-object",src:k})],-1)),be={class:"text-content"},ve=g(()=>e("i",{class:"fas fa-download"},null,-1)),we=g(()=>e("picture",null,[e("source",{srcset:te,type:"image/avif"}),e("source",{srcset:ee,type:"image/webp"}),e("source",{srcset:ie,type:"image/jpg"}),e("img",{class:"media-object",src:W})],-1)),ye={class:"text-content"},$e=["disabled"],ze=g(()=>e("i",{class:"fas fa-download"},null,-1)),ke=g(()=>e("picture",null,[e("source",{srcset:ae,type:"image/avif"}),e("source",{srcset:se,type:"image/webp"}),e("source",{srcset:ne,type:"image/jpg"}),e("img",{class:"media-object",src:k})],-1)),Ve={class:"text-content"},Se=g(()=>e("i",{class:"fas fa-download"},null,-1));function je(t,i,s,V,h,a){const d=_("ParticipantRow"),m=_("tooltip");return r(),o("div",null,[a.finished?(r(),o("div",re,n(t.$t("organizer.finished",{finished_at:a.endDateLong})),1)):c("",!0),e("table",oe,[e("caption",null,n(t.$t("organizer.list.caption")),1),e("thead",null,[e("tr",de,[e("th",{style:S(a.finished?"width: 25%":"width: 33%"),scope:"col"},n(t.$t("organizer.list.name")),5),e("th",{style:S(a.finished?"width: 25%":"width: 33%"),scope:"col"},n(t.$t("organizer.list.email")),5),a.finished?(r(),o("th",le,n(t.$t("organizer.list.target")),1)):c("",!0),e("th",{style:S(a.canWithdraw?"width: 25%":"width: 33%"),scope:"col"},n(t.$t("organizer.list.status")),5),!a.finished&&a.canWithdraw?(r(),o("th",ue,n(t.$t("organizer.list.withdraw")),1)):c("",!0)])]),e("tbody",null,[(r(!0),o(P,null,J(s.participants,(l,v)=>(r(),$(d,L({key:l.hash},l,{participants:s.participants,finished:a.finished,canWithdraw:a.canWithdraw,updateEmail:w=>a.updateEmail(v,w),updateName:w=>a.updateName(v,w),onResend:()=>a.resendTarget(v)}),null,16,["participants","finished","canWithdraw","updateEmail","updateName","onResend"]))),128))])]),a.finished?c("",!0):(r(),$(m,{key:1,direction:"top"},{tooltip:u(()=>[ce,e("div",he,[e("h3",null,n(t.$t("organizer.end.button-tooltip.title")),1),e("p",null,n(t.$t("organizer.end.button-tooltip.content")),1)])]),default:u(()=>[e("button",{type:"button",class:"btn btn-warning",onClick:i[0]||(i[0]=(...l)=>t.confirmEnd&&t.confirmEnd(...l))},[pe,y(" "+n(t.$t("organizer.end.button")),1)])]),_:1})),p(m,{direction:"top"},{tooltip:u(()=>[me,e("div",ge,[e("h3",null,n(t.$t("organizer.purge.button-tooltip.title")),1),e("p",null,n(t.$t("organizer.purge.button-tooltip.content")),1)])]),default:u(()=>[e("button",{type:"button",class:"btn btn-danger",onClick:i[1]||(i[1]=(...l)=>a.confirmPurge&&a.confirmPurge(...l))},[_e,y(" "+n(t.$t("organizer.purge.button",{deletes_at:a.deletionDateLong})),1)])]),_:1}),s.draw.next_solvable?(r(),o(P,{key:2},[p(m,{direction:"top"},{tooltip:u(()=>[fe,e("div",be,[e("h3",null,n(t.$t("organizer.download.button_initial-tooltip.title")),1),e("p",null,n(t.$t("organizer.download.button_initial-tooltip.content")),1)])]),default:u(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:i[2]||(i[2]=(...l)=>a.download&&a.download(...l))},[ve,y(" "+n(t.$t("organizer.download.button_initial")),1)])]),_:1}),p(m,{direction:"top"},{tooltip:u(()=>[we,e("div",ye,[e("h3",null,n(t.$t("organizer.download.button_final-tooltip.title")),1),e("p",null,n(t.$t("organizer.download.button_final-tooltip.explain")),1)])]),default:u(()=>[e("button",{disabled:!a.finished,type:"button",class:"btn btn-primary",onClick:i[3]||(i[3]=(...l)=>a.downloadPlus&&a.downloadPlus(...l))},[ze,y(" "+n(t.$t("organizer.download.button_final")),1)],8,$e)]),_:1})],64)):(r(),$(m,{key:3,direction:"top"},{tooltip:u(()=>[ke,e("div",Ve,[e("h3",null,n(t.$t("organizer.download.button-tooltip.title")),1),e("p",null,n(t.$t("organizer.download.button-tooltip.content")),1)])]),default:u(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:i[4]||(i[4]=(...l)=>a.download&&a.download(...l))},[Se,y(" "+n(t.$t("organizer.download.button")),1)])]),_:1}))])}var Ee=z(Mt,[["render",je],["__scopeId","data-v-7119bea2"]]);const Ue={components:{FetcherLayout:B,NavPageLink:R,OrganizerForm:Ee},props:{routes:{type:Object}},methods:{deepMerge:C}};function Pe(t,i,s,V,h,a){const d=_("i18n-t"),m=_("NavPageLink"),l=_("OrganizerForm"),v=_("FetcherLayout");return r(),$(v,{route:s.routes.fetch},{"navbar-right":u(()=>[p(m,{href:t.route("form.index")},{default:u(()=>[p(d,{keypath:"common.nav.go"})]),_:1},8,["href"]),p(m,{href:t.route("dashboard")},{default:u(()=>[p(d,{keypath:"common.nav.dashboard"})]),_:1},8,["href"])]),default:u(w=>[p(l,K(X(a.deepMerge(w,{routes:s.routes}))),null,16)]),_:1},8,["route"])}var We=z(Ue,[["render",Pe]]);export{We as default};
