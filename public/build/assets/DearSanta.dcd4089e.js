import k from"./FetcherLayout.b4b9b0e2.js";import{N as T}from"./NavPageLink.4d27d314.js";import{T as L,u as F,r as j}from"./Tooltip.584175fd.js";import{d as y,f as g}from"./fetch.01f53e84.js";import{E as N}from"./echo.4216f5db.js";import{E as O}from"./EmailStatus.293a952a.js";import{A as q}from"./AjaxForm.5d085a2d.js";import{r as l,o,d as i,t as s,j as v,a as d,w as c,e as t,k as C,v as E,i as B,F as R,l as U,c as b,b as S,p as I,m as M,n as V,h as P}from"./app.6256a668.js";import{_ as w}from"./Layout.7e513d1b.js";const z={components:{EmailStatus:O,Tooltip:L,AjaxForm:q},setup:()=>({v$:F()}),validations(){return{content:{required:j}}},props:{draw:{type:Object,required:!0},participant:{type:Object,required:!0},dearSantas:{type:Object,required:!0},routes:{type:Object,required:!0},targetDearSantaLastUpdate:{type:String,required:!0}},data(){return{content:""}},computed:{dearSantasByDate(){return Object.values(this.dearSantas).map(e=>Object.assign(e,e.mail)).sort((e,r)=>new Date(e.created_at)>new Date(r.created_at)?-1:1).map(e=>(e.created_at=new Date(e.created_at).toLocaleString("fr-FR"),e))||[]},finished(){return!!this.draw.finished_at},checkUpdates(){return!!Object.values(this.dearSantas).find(e=>e.mail.delivery_status!=="error")},recentTargetDearSanta(){return new Date().getTime()-new Date(this.targetDearSantaLastUpdate).getTime()<5*60*1e3}},created(){N.channel("draw."+this.draw.hash).listen(".mail.update",e=>{this.dearSantas[e.id]&&(this.dearSantas[e.id].mail.delivery_status=e.delivery_status,this.dearSantas[e.id].mail.updated_at=e.updated_at)}),window.localStorage.setItem("secretsanta",JSON.stringify(y(JSON.parse(window.localStorage.getItem("secretsanta"))||{},{[this.draw.hash]:{title:this.draw.mail_title,creation:this.draw.created_at,expiration:this.draw.expires_at,organizerName:this.draw.organizer_name,links:{[this.participant.hash]:{name:this.participant.name,link:window.location.href}}}})))},methods:{success(e){e.email.updated_at||(e.email.updated_at=new Date),this.$set(this.dearSantas,e.email.id,e.email)},reset(){this.content=""},resend(e){return this.dearSantas[e].mail.delivery_status="created",this.dearSantas[e].mail.updated_at=new Date().getTime(),g(this.dearSantas[e].resendUrl)},resend_target(){return this.targetDearSantaLastUpdate=new Date().getTime(),g(this.routes.resendTarget)},nl2br(e){return e.replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br />$2")},e(e){var r=document.createElement("p");return r.appendChild(document.createTextNode(e)),r.innerHTML}}},D=e=>(I("data-v-c1c02394"),e=e(),M(),e),A={key:0,class:"alert alert-warning",role:"alert"},H={class:"form-group"},J={for:"mailContent"},G={class:"input-group"},K=["placeholder","aria-invalid"],Q={key:0,class:"invalid-tooltip"},W={class:"table table-hover"},X={class:"table-active"},Y={scope:"col"},Z={scope:"col"},x={scope:"col"},ee=["innerHTML"],te={key:0,class:"no-email"},ae={colspan:"3"},re={class:"text-center"},ne={class:"text-content"},se={disabled:!0,type:"button",class:"btn btn-outline-secondary"},oe=D(()=>t("i",{class:"fas fa-redo"},null,-1)),ie=D(()=>t("i",{class:"fas fa-redo"},null,-1));function de(e,r,u,$,_,n){const p=l("AjaxForm"),m=l("EmailStatus"),h=l("Tooltip");return o(),i("div",null,[n.finished?(o(),i("div",A,s(e.$t("dearsanta.finished",{finished_at:e.endDateLong})),1)):v("",!0),d(p,{action:u.routes.contactUrl,v$:e.v$,onSuccess:n.success,onReset:n.reset,autoReset:!0},{default:c(()=>[t("fieldset",null,[t("div",H,[t("label",J,s(e.$t("dearsanta.content.label")),1),t("div",G,[C(t("textarea",{id:"mailContent","onUpdate:modelValue":r[0]||(r[0]=a=>_.content=a),name:"content",placeholder:e.$t("dearsanta.content.placeholder"),class:B({"form-control":!0,"is-invalid":e.v$.content.$error}),"aria-invalid":e.v$.content.$error,onBlur:r[1]||(r[1]=a=>e.v$.content.$touch())},null,42,K),[[E,_.content]]),e.v$.content.required?v("",!0):(o(),i("div",Q,s(e.$t("validation.custom.dearSanta.content.required")),1))])])])]),_:1},8,["action","v$","onSuccess","onReset"]),t("table",W,[t("caption",null,s(e.$t("dearsanta.list.caption")),1),t("thead",null,[t("tr",X,[t("th",Y,s(e.$t("dearsanta.list.date")),1),t("th",Z,s(e.$t("dearsanta.list.body")),1),t("th",x,s(e.$t("dearsanta.list.status")),1)])]),t("tbody",null,[(o(!0),i(R,null,U(n.dearSantasByDate,a=>(o(),i("tr",{key:a.id,class:"email"},[t("td",null,s(a.created_at),1),t("td",null,[t("p",{innerHTML:n.nl2br(n.e(a.mail_body))},null,8,ee)]),t("td",null,[d(m,{delivery_status:a.mail.delivery_status,last_update:a.mail.updated_at,onRedo:f=>n.resend(a.id)},null,8,["delivery_status","last_update","onRedo"])])]))),128)),e.emails.length===0?(o(),i("tr",te,[t("td",ae,s(e.$t("dearsanta.list.empty")),1)])):v("",!0)])]),t("div",re,[n.recentTargetDearSanta?(o(),b(h,{key:0,direction:"top"},{tooltip:c(()=>[t("div",ne,s(e.$t("common.email.recent")),1)]),default:c(()=>[t("button",se,[oe,S(" "+s(e.$t("dearsanta.resend.button")),1)])]),_:1})):(o(),i("button",{key:1,class:"btn btn-info btn-lg",onClick:r[2]||(r[2]=(...a)=>n.resend_target&&n.resend_target(...a))},[ie,S(" "+s(e.$t("dearsanta.resend.button")),1)]))])])}var le=w(z,[["render",de],["__scopeId","data-v-c1c02394"]]);const ce={components:{FetcherLayout:k,NavPageLink:T,DearSantaForm:le},props:{routes:{type:Object}},methods:{deepMerge:y}};function ue(e,r,u,$,_,n){const p=l("i18n-t"),m=l("NavPageLink"),h=l("DearSantaForm"),a=l("FetcherLayout");return o(),b(a,{route:u.routes.fetch},{"navbar-right":c(()=>[d(m,{href:e.route("form.index")},{default:c(()=>[d(p,{keypath:"common.nav.go"})]),_:1},8,["href"]),d(m,{href:e.route("dashboard")},{default:c(()=>[d(p,{keypath:"common.nav.dashboard"})]),_:1},8,["href"])]),default:c(f=>[d(h,V(P(n.deepMerge(f,{routes:u.routes}))),null,16)]),_:1},8,["route"])}var be=w(ce,[["render",ue]]);export{be as default};
