import{F as D}from"./Fetcher.bd3110ca.js";import{N as q}from"./NavPageLink.dacc745d.js";import{d as T,f as g,b as P}from"./fetch.dcbaaa5f.js";import"./moment.9709ab41.js";import{T as B,E as R}from"./Tooltip.0e4cb4a1.js";import{o as r,d as l,e,t as n,j as h,k as G,y as H,z as C,u as M,p as $,m as I,r as b,a as p,A as j,F as U,l as Q,c as z,w as c,b as y,n as Y,h as Z}from"./app.5fe4871d.js";import{_ as V}from"./plugin-vue_export-helper.f2aa9cb4.js";import{E as A}from"./EmailStatus.0172aebc.js";import"./Fetcher.fe380d90.js";var J={data:()=>({data:{},states:{},previousState:null,state:null}),methods:{send(t,i){this.data=i||{};var s=this.states[this.state][t]||this.states[this.state]["*"];s&&(this.previousState=this.state,this.state=s,(this["state"+this.state[0].toUpperCase()+this.state.slice(1)]||function(){})())}}};const K={mixins:[J],inheritAttrs:!1,props:{modelValue:{type:String,required:!0},submit:{type:Function,required:!0},validate:{type:Function,required:!0},disabled:{type:Boolean,default:!1}},data(){return{states:Object.freeze({view:{edit:"editing"},editing:{validate:"editingValidating",cancel:"view",blur:"editingBlur"},editingBlur:{same:"view",different:"editingValidating"},editingValid:{validate:"editingValidating",submit:"viewUpdating",cancel:"view",blur:"editingBlur"},editingInvalid:{validate:"editingValidating",cancel:"view"},editingValidating:{valid:"editingValid",invalid:"editingInvalid"},viewUpdating:{success:"viewUpdated",error:"viewError"},viewUpdated:{edit:"editing",timer:"view"},viewError:{edit:"editing",resend:"viewUpdating"}}),state:"view",newValue:this.modelValue}},computed:{isSame(){return this.newValue===this.modelValue},view(){return this.state.startsWith("view")},updating(){return this.state==="viewUpdating"}},methods:{onBlur(){this.send("blur")},onCancel(){this.send("cancel")},onInput(){this.send("validate")},onSubmit(){this.send("submit")},onResend(){this.send("resend")},stateView(){this.newValue=this.modelValue},stateEditing(){this.$nextTick(()=>this.$refs.input.focus())},stateEditingBlur(){this.isSame?this.send("same"):this.send("different")},stateEditingValidating(){this.validate(this.newValue).then(()=>{this.send("valid")}).catch(t=>{this.send("invalid",{message:t})})},stateViewUpdating(){this.submit(this.newValue).then(()=>{this.send("success")}).catch(t=>{this.send("error",{message:t})})},stateViewUpdated(){setTimeout(()=>{this.send("timer")},5e3)}}},f=t=>($("data-v-ff498bb8"),t=t(),I(),t),X=["disabled"],x=["data-state","data-previous-state"],tt={role:"alert",style:{display:"none"}},et={key:0,class:"input-group-prepend"},it=f(()=>e("i",{class:"input-group-text fas fa-spinner fa-spin"},null,-1)),at=[it],st={key:1,class:"input-group-prepend"},nt=f(()=>e("i",{class:"input-group-text fas fa-check"},null,-1)),rt=[nt],ot={key:2,class:"input-group-prepend"},dt=["title"],lt=["disabled","aria-invalid","title"],ut={key:3,class:"invalid-tooltip"},ct={class:"input-group-append"},ht=["disabled"],pt=f(()=>e("i",{class:"fas fa-sync"},null,-1)),mt=[pt],_t=["disabled"],gt=f(()=>e("i",{class:"fas fa-edit"},null,-1)),bt=[gt],ft=["disabled"],vt=f(()=>e("i",{class:"fas fa-check-circle"},null,-1)),wt=[vt],yt=f(()=>e("i",{class:"fas fa-times-circle"},null,-1)),zt=[yt];function kt(t,i,s,E,u,a){return r(),l("form",{method:"post",autocomplete:"off",onSubmit:i[6]||(i[6]=M((...o)=>a.onSubmit&&a.onSubmit(...o),["prevent"]))},[e("fieldset",{disabled:a.updating||s.disabled},[e("div",{class:"input-group","data-state":u.state,"data-previous-state":t.previousState},[e("h2",tt,n(t.data.message),1),a.updating?(r(),l("div",et,at)):h("",!0),u.state==="viewUpdated"?(r(),l("div",st,rt)):h("",!0),u.state==="viewError"?(r(),l("div",ot,[e("i",{class:"input-group-text fas fa-exclamation-circle",title:t.data.message},null,8,dt)])):h("",!0),G(e("input",C({ref:"input","onUpdate:modelValue":i[0]||(i[0]=o=>u.newValue=o),name:"input"},t.$attrs,{class:{"form-control":!0,"is-invalid":u.state.endsWith("Invalid")},disabled:a.view,"aria-invalid":u.state.endsWith("Invalid"),title:t.data.message,onInput:i[1]||(i[1]=(...o)=>a.onInput&&a.onInput(...o))}),null,16,lt),[[H,u.newValue]]),u.state.endsWith("Invalid")?(r(),l("div",ut,n(t.data.message),1)):h("",!0),e("div",ct,[u.state==="viewError"?(r(),l("button",{key:0,type:"button",class:"btn btn-outline-primary",disabled:s.disabled,onClick:i[2]||(i[2]=(...o)=>a.onResend&&a.onResend(...o))},mt,8,ht)):h("",!0),u.state.startsWith("view")?(r(),l("button",{key:1,type:"button",class:"btn btn-outline-primary",disabled:s.disabled,onClick:i[3]||(i[3]=o=>t.send("edit"))},bt,8,_t)):h("",!0),u.state.startsWith("edit")?(r(),l("button",{key:2,type:"button",class:"btn btn-outline-success",disabled:a.isSame||!u.state.endsWith("Valid")||s.disabled,onClick:i[4]||(i[4]=(...o)=>a.onSubmit&&a.onSubmit(...o))},wt,8,ft)):h("",!0),u.state.startsWith("edit")?(r(),l("button",{key:3,type:"button",class:"btn btn-outline-danger",onClick:i[5]||(i[5]=(...o)=>a.onCancel&&a.onCancel(...o))},zt)):h("",!0)])],8,x)],8,X)],32)}var Vt=V(K,[["render",kt],["__scopeId","data-v-ff498bb8"]]);const St={components:{InputEdit:Vt,EmailStatus:A},props:{name:{type:String,required:!0},email:{type:String,required:!0},target:{type:String},mail:{type:Object,required:!0},participants:{type:Object,required:!0},finished:{type:Boolean,required:!0},canWithdraw:{type:Boolean,required:!0},validate:{type:Function,required:!0},updateEmail:{type:Function,required:!0},updateName:{type:Function,required:!0}}},Et={key:0},jt={key:1},Pt=e("i",{class:"fas fa-minus"},null,-1);function Ut(t,i,s,E,u,a){const o=b("InputEdit"),m=b("EmailStatus");return r(),l("tr",null,[e("td",null,[p(o,{modelValue:s.name,submit:s.updateName,validate:d=>s.validate("name",d),disabled:s.finished},null,8,["modelValue","submit","validate","disabled"])]),e("td",null,[p(o,{modelValue:s.email,submit:s.updateEmail,validate:d=>s.validate("email",d),disabled:s.finished},null,8,["modelValue","submit","validate","disabled"])]),s.finished?(r(),l("td",Et,n(s.target),1)):h("",!0),e("td",null,[p(m,{delivery_status:s.mail.delivery_status,last_update:s.mail.updated_at,disabled:s.finished,onRedo:i[0]||(i[0]=d=>t.$emit("resend"))},null,8,["delivery_status","last_update","disabled"])]),s.canWithdraw?(r(),l("td",jt,[e("button",{type:"button",class:"btn btn-outline-danger participant-remove",onClick:i[1]||(i[1]=d=>t.confirmWithdrawal(t.k))},[Pt,e("span",null,n(t.$t("organizer.withdraw.button")),1)])])):h("",!0)])}var Tt=V(St,[["render",Ut]]),Ct="/build/assets/srikanta-h-u-TrGVhbsUf40-unsplash.be9b6bde.avif",$t="/build/assets/srikanta-h-u-TrGVhbsUf40-unsplash.4471f4b6.webp",O="/build/assets/srikanta-h-u-TrGVhbsUf40-unsplash.6816af8d.jpg",It="/build/assets/lynda-hinton-QyDLHeUerd4-unsplash.9b9c28b0.avif",Ot="/build/assets/lynda-hinton-QyDLHeUerd4-unsplash.4ee30b51.webp",L="/build/assets/lynda-hinton-QyDLHeUerd4-unsplash.5f3e2c02.jpg",N="/build/assets/rune-haugseng-UCzjZPCGV1Y-unsplash.3341c429.avif",F="/build/assets/rune-haugseng-UCzjZPCGV1Y-unsplash.135a646a.webp",S="/build/assets/rune-haugseng-UCzjZPCGV1Y-unsplash.fec52c3e.jpg",Lt="/build/assets/mike-arney-9r-_2gzP37k-unsplash.080a6716.avif",Nt="/build/assets/mike-arney-9r-_2gzP37k-unsplash.eca00fd8.webp",W="/build/assets/mike-arney-9r-_2gzP37k-unsplash.6dd52eac.jpg";const Ft={components:{Tooltip:B,ParticipantRow:Tt},props:{participants:{type:Object,required:!0},draw:{type:Object,required:!0},routes:{type:Object,required:!0}},computed:{canWithdraw(){return Object.keys(this.participants).length>3},checkUpdates(){return!!Object.values(this.participants).find(t=>t.mail.delivery_status!=="error")},finished(){return!!this.draw.finished_at},endDateLong(){return new Date(this.draw.finished_at).toLocaleString("fr-FR",{day:"numeric",month:"long",year:"numeric"})},deletionDateLong(){return new Date(this.draw.deletes_at).toLocaleString("fr-FR",{day:"numeric",month:"long",year:"numeric"})}},created(){R.channel("draw."+this.draw.hash).listen(".mail.update",t=>{var i=Object.keys(this.participants).find(s=>this.participants[s].mail.id===t.id);i&&(this.participants[i].mail.delivery_status=t.delivery_status,this.participants[i].mail.updated_at=t.updated_at)}),window.localStorage.setItem("secretsanta",JSON.stringify(T(JSON.parse(window.localStorage.getItem("secretsanta"))||{},{[this.draw.hash]:{title:this.draw.mail_title,creation:this.draw.created_at,deletion:this.draw.deletes_at,organizerName:this.draw.organizer_name,links:{org:{link:window.location.href}}}})))},methods:{confirmPurge(){let t={okText:this.$t("organizer.purge.confirm.ok"),cancelText:this.$t("organizer.purge.confirm.cancel"),verification:this.$t("organizer.purge.confirm.value"),verificationHelp:this.$t("organizer.purge.confirm.help"),type:"hard",customClass:"purge"},i={title:this.$t("organizer.purge.confirm.title",{deletion:this.deletionDateLong}),body:""};this.draw.next_solvable&&!this.finished?i.body=this.$t("organizer.purge.confirm.body_final"):this.finished?i.body=this.$t("organizer.purge.confirm.body_finished"):i.body=this.$t("organizer.purge.confirm.body_nofinal"),this.$dialog.confirm(i,t).then(this.purge)},purge(){return g(this.routes.deleteUrl,"DELETE").then(t=>{this.$dialog.alert(t.message).then(()=>window.location.pathname="/")})},precog(t,i){if(t==="email")return g(this.participants[k].changeEmailUrl,"POST",{email:i}).catch(s=>Promise.reject(s.errors.email[0]));if(t==="name")return g(this.participants[k].changeNameUrl,"POST",{name:i}).catch(s=>Promise.reject(s.errors.name[0]))},resendTarget(t){return this.participants[t].mail.delivery_status="created",this.participants[t].mail.updated_at=new Date().getTime(),g(this.participants[t].resendTargetUrl)},updateEmail(t,i){return this.participants[t].email=i,this.participants[t].mail.delivery_status="created",this.participants[t].mail.updated_at=new Date().getTime(),g(this.participants[t].changeEmailUrl,"POST",{email:i}).catch(s=>Promise.reject(s.errors.email[0]))},updateName(t,i){return this.participants[t].name=i,g(this.participants[t].changeNameUrl,"POST",{name:i}).catch(s=>Promise.reject(s.errors.name[0]))},confirmWithdrawal(t){let i={okText:this.$t("organizer.withdraw.confirm.ok"),cancelText:this.$t("organizer.withdraw.confirm.cancel"),verification:this.$t("organizer.withdraw.confirm.value"),verificationHelp:this.$t("organizer.withdraw.confirm.help"),type:"hard",customClass:"withdraw"};this.$dialog.confirm({title:this.$t("organizer.withdraw.confirm.title",{deletion:this.deletionDateLong}),body:this.$t("organizer.withdraw.confirm.body",{name:this.participants[t].name})},i).then(()=>this.withdraw(t))},withdraw(t){return g(this.participants[t].withdrawalUrl).then(i=>{this.$delete(this.participants,t),this.$dialog.alert(i.message)})},download(){g(this.routes.csvInitUrl,"GET","",{responseType:"blob"}).then(t=>{P(t,"secretsanta_"+this.draw.hash+"_init.csv","text/csv")})},downloadPlus(){g(this.routes.csvFinalUrl,"GET","",{responseType:"blob"}).then(t=>{P(t,"secretsanta_"+this.draw.hash+"_full.csv","text/csv")})}}},_=t=>($("data-v-741b52b7"),t=t(),I(),t),Wt=Ct,Dt=$t,qt=O,Bt=It,Rt=Ot,Gt=L,Ht=N,Mt=F,Qt=S,Yt=Lt,Zt=Nt,At=W,Jt=N,Kt=F,Xt=S,xt={key:0,class:"alert alert-warning",role:"alert"},te={class:"table table-hover"},ee={class:"table-active"},ie={key:0,style:{width:"25%"},scope:"col"},ae={key:1,style:{width:"3%"},scope:"col"},se=_(()=>e("picture",null,[e("source",{srcset:Wt,type:"image/avif"}),e("source",{srcset:Dt,type:"image/webp"}),e("source",{srcset:qt,type:"image/jpg"}),e("img",{class:"media-object",src:O})],-1)),ne={class:"text-content"},re=_(()=>e("i",{class:"fas fa-calendar-check"},null,-1)),oe=_(()=>e("picture",null,[e("source",{srcset:Bt,type:"image/avif"}),e("source",{srcset:Rt,type:"image/webp"}),e("source",{srcset:Gt,type:"image/jpg"}),e("img",{class:"media-object",src:L})],-1)),de={class:"text-content"},le=_(()=>e("i",{class:"fas fa-trash"},null,-1)),ue=_(()=>e("picture",null,[e("source",{srcset:Ht,type:"image/avif"}),e("source",{srcset:Mt,type:"image/webp"}),e("source",{srcset:Qt,type:"image/jpg"}),e("img",{class:"media-object",src:S})],-1)),ce={class:"text-content"},he=_(()=>e("i",{class:"fas fa-download"},null,-1)),pe=_(()=>e("picture",null,[e("source",{srcset:Yt,type:"image/avif"}),e("source",{srcset:Zt,type:"image/webp"}),e("source",{srcset:At,type:"image/jpg"}),e("img",{class:"media-object",src:W})],-1)),me={class:"text-content"},_e=["disabled"],ge=_(()=>e("i",{class:"fas fa-download"},null,-1)),be=_(()=>e("picture",null,[e("source",{srcset:Jt,type:"image/avif"}),e("source",{srcset:Kt,type:"image/webp"}),e("source",{srcset:Xt,type:"image/jpg"}),e("img",{class:"media-object",src:S})],-1)),fe={class:"text-content"},ve=_(()=>e("i",{class:"fas fa-download"},null,-1));function we(t,i,s,E,u,a){const o=b("ParticipantRow"),m=b("tooltip");return r(),l("div",null,[a.finished?(r(),l("div",xt,n(t.$t("organizer.finished",{finished_at:a.endDateLong})),1)):h("",!0),e("table",te,[e("caption",null,n(t.$t("organizer.list.caption")),1),e("thead",null,[e("tr",ee,[e("th",{style:j(a.finished?"width: 25%":"width: 33%"),scope:"col"},n(t.$t("organizer.list.name")),5),e("th",{style:j(a.finished?"width: 25%":"width: 33%"),scope:"col"},n(t.$t("organizer.list.email")),5),a.finished?(r(),l("th",ie,n(t.$t("organizer.list.target")),1)):h("",!0),e("th",{style:j(a.canWithdraw?"width: 25%":"width: 33%"),scope:"col"},n(t.$t("organizer.list.status")),5),!a.finished&&a.canWithdraw?(r(),l("th",ae,n(t.$t("organizer.list.withdraw")),1)):h("",!0)])]),e("tbody",null,[(r(!0),l(U,null,Q(s.participants,(d,v)=>(r(),z(o,C({key:d.hash},d,{participants:s.participants,finished:a.finished,canWithdraw:a.canWithdraw,updateEmail:w=>a.updateEmail(v,w),updateName:w=>a.updateName(v,w),onResend:()=>a.resendTarget(v)}),null,16,["participants","finished","canWithdraw","updateEmail","updateName","onResend"]))),128))])]),a.finished?h("",!0):(r(),z(m,{key:1,direction:"top"},{tooltip:c(()=>[se,e("div",ne,[e("h3",null,n(t.$t("organizer.end.button-tooltip.title")),1),e("p",null,n(t.$t("organizer.end.button-tooltip.content")),1)])]),default:c(()=>[e("button",{type:"button",class:"btn btn-warning",onClick:i[0]||(i[0]=(...d)=>t.confirmEnd&&t.confirmEnd(...d))},[re,y(" "+n(t.$t("organizer.end.button")),1)])]),_:1})),p(m,{direction:"top"},{tooltip:c(()=>[oe,e("div",de,[e("h3",null,n(t.$t("organizer.purge.button-tooltip.title")),1),e("p",null,n(t.$t("organizer.purge.button-tooltip.content")),1)])]),default:c(()=>[e("button",{type:"button",class:"btn btn-danger",onClick:i[1]||(i[1]=(...d)=>a.confirmPurge&&a.confirmPurge(...d))},[le,y(" "+n(t.$t("organizer.purge.button",{deletes_at:a.deletionDateLong})),1)])]),_:1}),s.draw.next_solvable?(r(),l(U,{key:2},[p(m,{direction:"top"},{tooltip:c(()=>[ue,e("div",ce,[e("h3",null,n(t.$t("organizer.download.button_initial-tooltip.title")),1),e("p",null,n(t.$t("organizer.download.button_initial-tooltip.content")),1)])]),default:c(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:i[2]||(i[2]=(...d)=>a.download&&a.download(...d))},[he,y(" "+n(t.$t("organizer.download.button_initial")),1)])]),_:1}),p(m,{direction:"top"},{tooltip:c(()=>[pe,e("div",me,[e("h3",null,n(t.$t("organizer.download.button_final-tooltip.title")),1),e("p",null,n(t.$t("organizer.download.button_final-tooltip.explain")),1)])]),default:c(()=>[e("button",{disabled:!a.finished,type:"button",class:"btn btn-primary",onClick:i[3]||(i[3]=(...d)=>a.downloadPlus&&a.downloadPlus(...d))},[ge,y(" "+n(t.$t("organizer.download.button_final")),1)],8,_e)]),_:1})],64)):(r(),z(m,{key:3,direction:"top"},{tooltip:c(()=>[be,e("div",fe,[e("h3",null,n(t.$t("organizer.download.button-tooltip.title")),1),e("p",null,n(t.$t("organizer.download.button-tooltip.content")),1)])]),default:c(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:i[4]||(i[4]=(...d)=>a.download&&a.download(...d))},[ve,y(" "+n(t.$t("organizer.download.button")),1)])]),_:1}))])}var ye=V(Ft,[["render",we],["__scopeId","data-v-741b52b7"]]);const ze={components:{FetcherLayout:D,NavPageLink:q,OrganizerForm:ye},props:{routes:{type:Object}},methods:{deepMerge:T}};function ke(t,i,s,E,u,a){const o=b("i18n-t"),m=b("NavPageLink"),d=b("OrganizerForm"),v=b("FetcherLayout");return r(),z(v,{route:s.routes.fetch},{"navbar-right":c(()=>[p(m,{href:t.route("form.index")},{default:c(()=>[p(o,{keypath:"common.nav.go"})]),_:1},8,["href"]),p(m,{href:t.route("dashboard")},{default:c(()=>[p(o,{keypath:"common.nav.dashboard"})]),_:1},8,["href"])]),default:c(w=>[p(d,Y(Z(a.deepMerge(w,{routes:s.routes}))),null,16)]),_:1},8,["route"])}var Ie=V(ze,[["render",ke]]);export{Ie as default};
