image: lorisleiva/laravel-docker:latest

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    # We only want to cache the vendor folder.
    - vendor/

js-cs:
  stage: test
  cache: {} # Override with an empty object.
  script:
    - npm install eslint eslint-plugin-vue
    - eslint resources/js/
  allow_failure: true

sass-cs:
  stage: test
  cache: {} # Override with an empty object.
  script:
    - npm install sass-lint
    - sass-lint resources/sass/
  allow_failure: true

.before_script_composer:
  before_script:
    - apk add --no-cache imap-dev krb5-dev openssl-dev
    - PHP_OPENSSL=yes docker-php-ext-configure imap --with-kerberos --with-imap-ssl
    - docker-php-ext-install imap
    - composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts

php-cs:
  extends: .before_script_composer
  stage: test
  script:
    - composer require friendsofphp/php-cs-fixer
    - php-cs-fixer fix --dry-run
  allow_failure: true

phpunit:
  extends: .before_script_composer
  stage: test
  script:
    - cp .env.example .env
    - php artisan key:generate
    - phpunit --coverage-text --colors=never
