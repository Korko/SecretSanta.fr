image: lorisleiva/laravel-docker:latest

.before_script_npm:
  before_script:
    - npm install

js-cs:
  extends: .before_script_npm
  stage: test
  script:
    - npm run lint:js
  rules:
    - changes:
      - "resources/js/**/*"
  allow_failure: true

sass-cs:
  extends: .before_script_npm
  stage: test
  script:
    - npm run lint:css
  rules:
    - changes:
      - "resources/sass/**/*"
  allow_failure: true

.before_script_composer:
  rules:
    - changes:
      - "**/*.php"
  before_script:
    - apk add --no-cache imap-dev krb5-dev openssl-dev
    - PHP_OPENSSL=yes docker-php-ext-configure imap --with-kerberos --with-imap-ssl
    - docker-php-ext-install imap
    - composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts

php-cs:
  extends: .before_script_composer
  stage: test
  script:
    - composer check-style
  allow_failure: true

phpunit:
  extends: .before_script_composer
  stage: test
  script:
    - cp .env.example .env
    - php artisan key:generate
    - php artisan test
