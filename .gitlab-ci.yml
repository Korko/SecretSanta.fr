image: lorisleiva/laravel-docker:latest

js-cs:
  stage: test
  cache: {} # Override with an empty object.
  script:
    - ./node_modules/.bin/eslint resources/js/
  rules:
    - changes:
      - "resources/js/**/*"
  allow_failure: true

sass-cs:
  stage: test
  cache: {} # Override with an empty object.
  script:
    - ./node_modules/.bin/sass-lint resources/sass/
  rules:
    - changes:
      - "resources/sass/**/*"
  allow_failure: true

.before_script_composer:
  rules:
    - changes:
      - "**/*.php"
  before_script:
    - apk add --no-cache imap-dev krb5-dev openssl-dev
    - PHP_OPENSSL=yes docker-php-ext-configure imap --with-kerberos --with-imap-ssl
    - docker-php-ext-install imap
    - composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts

php-cs:
  extends: .before_script_composer
  stage: test
  script:
    - ./vendor/bin/php-cs-fixer fix --dry-run
  allow_failure: true

phpunit:
  extends: .before_script_composer
  stage: test
  script:
    - cp .env.example .env
    - php artisan key:generate
    - ./vendor/bin/phpunit --coverage-text --colors=never
